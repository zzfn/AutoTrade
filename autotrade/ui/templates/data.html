{% extends "layout.html" %} {% block content %}
<div id="data-root"></div>
{% endblock %} {% block scripts %}
<script type="text/babel">
  {% raw %}
  const DataPage = () => {
    const [dataStatus, setDataStatus] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    const [syncDays, setSyncDays] = React.useState(730);
    const [syncInterval, setSyncInterval] = React.useState("1d");
    const [symbols, setSymbols] = React.useState("");

    // åŠ è½½æ•°æ®çŠ¶æ€
    const loadDataStatus = async () => {
      try {
        const res = await fetch("/api/data/sync/status");
        const status = await res.json();
        setDataStatus(status);
        setLoading(false);
      } catch (e) {
        console.error("åŠ è½½æ•°æ®çŠ¶æ€å¤±è´¥:", e);
        setLoading(false);
      }
    };

    React.useEffect(() => {
      loadDataStatus();
      const interval = setInterval(loadDataStatus, 2000);
      return () => clearInterval(interval);
    }, []);

    // å¯åŠ¨æ•°æ®åŒæ­¥
    const handleDataSync = async () => {
      try {
        const symbolList = symbols.split(",").map(s => s.trim().toUpperCase()).filter(s => s);
        await fetch("/api/data/sync", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            symbols: symbolList,
            days: syncDays,
            interval: syncInterval,
            update_mode: "append"
          }),
        });
        loadDataStatus();
      } catch (e) {
        console.error("å¯åŠ¨æ•°æ®åŒæ­¥å¤±è´¥:", e);
      }
    };

    if (loading) {
      return (
        <div className="flex items-center justify-center h-64">
          <div className="flex flex-col items-center gap-4">
            <div className="w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
            <div className="text-slate-400 text-sm font-medium">åŠ è½½ä¸­...</div>
          </div>
        </div>
      );
    }

    return (
      <div className="space-y-6">
        <header className="mb-8">
          <h2 className="text-2xl font-bold text-slate-100 flex items-center gap-3">
            ğŸ“Š æ•°æ®ä¸­å¿ƒ
          </h2>
          <p className="text-slate-400 mt-2">
            ç®¡ç† Qlib æ•°æ®åº“ï¼ŒåŒæ­¥å…¨çƒåŠ A è‚¡å¸‚åœºè¡Œæƒ…æ•°æ®ï¼Œä¸ºæ¨¡å‹è®­ç»ƒå’Œå›æµ‹æä¾›ç¦»çº¿æ”¯æŒã€‚
          </p>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {/* åŒæ­¥é…ç½® */}
          <Card title="åŒæ­¥é…ç½®" className="col-span-1 md:col-span-1">
            <div className="space-y-6">
              <div>
                <label className="block text-xs text-slate-500 mb-2 font-bold uppercase tracking-wider">
                  åŒæ­¥æ ‡çš„ (æ”¯æŒé€šé…ç¬¦æˆ–é€—å·åˆ†éš”)
                </label>
                <textarea
                  className="w-full h-32 bg-slate-900/50 border border-slate-700/50 rounded-xl px-4 py-3 text-sm text-slate-200 outline-none focus:border-cyan-500/50 transition-all font-mono"
                  value={symbols}
                  onChange={(e) => setSymbols(e.target.value)}
                  placeholder=""
                />
                <p className="mt-2 text-[10px] text-slate-500 italic">
                  æç¤º: Qlib ä½¿ç”¨ .SH/.SZ åç¼€ã€‚è¾“å…¥ "ALL" æˆ–ç©ºå°†å–å†³äºåç«¯é…ç½®ã€‚
                </p>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs text-slate-500 mb-2 font-bold uppercase tracking-wider">
                    é¢‘ç‡
                  </label>
                  <select
                    value={syncInterval}
                    onChange={(e) => setSyncInterval(e.target.value)}
                    className="w-full bg-slate-900/50 border border-slate-700/50 rounded-xl px-4 py-2.5 text-sm text-slate-200 outline-none focus:border-cyan-500/50 transition-all"
                  >
                    <option value="1d">æ—¥çº¿ (Daily)</option>
                    <option value="1h">1å°æ—¶çº¿ (Hourly)</option>
                    <option value="5m">5åˆ†é’Ÿçº¿ (5-Min)</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs text-slate-500 mb-2 font-bold uppercase tracking-wider">
                    åŒæ­¥å¤©æ•°
                  </label>
                  <input
                    type="number"
                    value={syncDays}
                    onChange={(e) => setSyncDays(parseInt(e.target.value))}
                    className="w-full bg-slate-900/50 border border-slate-700/50 rounded-xl px-4 py-2.5 text-sm text-slate-200 outline-none focus:border-cyan-500/50"
                  />
                </div>
              </div>

              <button
                onClick={handleDataSync}
                disabled={dataStatus?.in_progress}
                className={`w-full py-3 px-6 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 ${
                  dataStatus?.in_progress
                    ? "bg-slate-800 text-slate-500 cursor-not-allowed"
                    : "bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 hover:scale-[1.01]"
                }`}
              >
                {dataStatus?.in_progress ? (
                  <>
                    <div className="w-4 h-4 border-2 border-slate-500 border-t-transparent rounded-full animate-spin"></div>
                    æ­£åœ¨åŒæ­¥...
                  </>
                ) : (
                  <>ğŸ“¥ å¼€å§‹åŒæ­¥æ•°æ®</>
                )}
              </button>
            </div>
          </Card>

          {/* åŒæ­¥çŠ¶æ€ */}
          <Card title="åŒæ­¥çŠ¶æ€" className="col-span-1 md:col-span-2">
            <div className="flex flex-col h-full gap-6">
              {dataStatus?.in_progress ? (
                <div className="flex-1 flex flex-col justify-center space-y-8 p-6 bg-cyan-500/5 rounded-2xl border border-cyan-500/20">
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center">
                          <span className="animate-spin text-xl">ğŸ”„</span>
                        </div>
                        <div>
                          <div className="text-sm font-bold text-slate-100">æ­£åœ¨è·å–å¸‚åœºæ•°æ®...</div>
                          <div className="text-xs text-slate-400">æ­£åœ¨å¤„ç† {dataStatus.current_symbol || "è¯·æ±‚"}</div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-black text-cyan-400">{dataStatus.progress}%</div>
                        <div className="text-[10px] text-slate-500 font-bold uppercase">å®Œæˆè¿›åº¦</div>
                      </div>
                    </div>

                    <div className="relative h-4 bg-slate-800 rounded-full overflow-hidden p-1">
                      <div
                        className="h-full bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full transition-all duration-500 shadow-[0_0_15px_rgba(6,182,212,0.5)]"
                        style={{ width: `${dataStatus.progress}%` }}
                      ></div>
                    </div>
                  </div>

                  <div className="p-4 bg-slate-900/80 rounded-xl border border-slate-700/50 font-mono text-xs text-cyan-300 min-h-[100px] max-h-[200px] overflow-y-auto">
                    <div className="flex items-center gap-2 mb-2 pb-2 border-b border-slate-700/30">
                      <span className="w-2 h-2 bg-emerald-500 rounded-full"></span>
                      å®æ—¶åŒæ­¥æ—¥å¿—
                    </div>
                    {dataStatus.message && (
                      <div className="animate-in fade-in slide-in-from-left-2 transition-all">
                        {dataStatus.message}
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                <div className="flex-1 flex flex-col items-center justify-center text-center p-12 bg-slate-800/20 border border-dashed border-slate-700/50 rounded-2xl">
                  <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-4">
                    <span className="text-2xl">âœ…</span>
                  </div>
                  <h3 className="text-lg font-bold text-slate-300">ç³»ç»Ÿå°±ç»ª</h3>
                  <p className="text-sm text-slate-500 max-w-sm mt-2">
                    å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„åŒæ­¥ä»»åŠ¡ã€‚ä½ å¯ä»¥é€šè¿‡å·¦ä¾§é¢æ¿è§¦å‘æ–°çš„æ•°æ®åŒæ­¥ï¼Œæˆ–è€…è®­ç»ƒåŸºäºç°æœ‰æ•°æ®çš„æ¨¡å‹ã€‚
                  </p>
                  {dataStatus?.message && (
                    <div className="mt-6 p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-emerald-400 text-xs">
                      ä¸Šæ¬¡ç»“æœ: {dataStatus.message}
                    </div>
                  )}
                </div>
              )}

              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                 <div className="p-4 bg-slate-800/30 rounded-xl border border-slate-700/30">
                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">æœ€ååŒæ­¥</div>
                    <div className="text-sm text-slate-200">
                       {dataStatus?.last_sync ? new Date(dataStatus.last_sync).toLocaleString() : "Never"}
                    </div>
                 </div>
                 <div className="p-4 bg-slate-800/30 rounded-xl border border-slate-700/30">
                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">Qlib è·¯å¾„</div>
                    <div className="text-xs text-slate-400 font-mono truncate" title="~/.qlib/qlib_data/cn_data">
                       ~/.qlib/qlib_data/cn_data
                    </div>
                 </div>
              </div>
            </div>
          </Card>
        </div>
      </div>
    );
  };

  const root = ReactDOM.createRoot(document.getElementById("data-root"));
  root.render(<DataPage />);
  {% endraw %}
</script>
{% endblock %}
