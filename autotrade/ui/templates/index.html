{% extends "layout.html" %} {% block content %}
<div id="dashboard-root"></div>
{% endblock %} {% block scripts %} {% raw %}
<script type="text/babel">
  // Portfolio History Chart Component
  const PortfolioHistoryChart = () => {
    const { data, status: connectionStatus } = useWebSocket(getWsUrl());
    const [historyData, setHistoryData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [period, setPeriod] = useState("1D");
    const [timeframe, setTimeframe] = useState("5Min");
    const chartRef = useRef(null);
    const chartInstanceRef = useRef(null);

    const fetchHistory = async () => {
      setLoading(true);
      setError(null);
      try {
        const res = await fetch(`/api/portfolio/history?period=${period}&timeframe=${timeframe}`);
        const payload = await res.json();

        if (payload.status === "success") {
          setHistoryData(payload.data);
        } else {
          setError(payload.message || "获取数据失败");
        }
      } catch (e) {
        console.error("Failed to fetch portfolio history:", e);
        setError("网络错误: " + e.message);
      } finally {
        setLoading(false);
      }
    };

    useEffect(() => {
      fetchHistory();
      // 每 30 秒刷新一次
      const interval = setInterval(fetchHistory, 30000);
      return () => clearInterval(interval);
    }, [period, timeframe]);

    useEffect(() => {
      if (!historyData || historyData.length === 0) return;

      const ctx = chartRef.current?.getContext("2d");
      if (!ctx) return;

      // 销毁旧图表
      if (chartInstanceRef.current) {
        chartInstanceRef.current.destroy();
      }

      // 准备数据
      const labels = historyData.map((d) => {
        // Alpaca 返回的 timestamp 是秒级，需要转换为毫秒
        const date = new Date(d.timestamp * 1000);
        // 格式化为美东时间
        return date.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
          timeZone: "America/New_York"
        });
      });
      const equityData = historyData.map((d) => d.equity);
      const baseValueData = historyData.map((d) => d.base_value);

      // 创建渐变
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, "rgba(6, 182, 212, 0.3)");
      gradient.addColorStop(1, "rgba(6, 182, 212, 0)");

      // 创建图表
      chartInstanceRef.current = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "总权益",
              data: equityData,
              borderColor: "#06b6d4",
              backgroundColor: gradient,
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 4,
              pointHoverBackgroundColor: "#06b6d4",
              pointHoverBorderColor: "#fff",
              pointHoverBorderWidth: 2,
            },
            {
              label: "基准值",
              data: baseValueData,
              borderColor: "#64748b",
              borderWidth: 2,
              borderDash: [5, 5],
              fill: false,
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 4,
              pointHoverBackgroundColor: "#64748b",
              pointHoverBorderColor: "#fff",
              pointHoverBorderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false,
          },
          plugins: {
            legend: {
              display: true,
              position: "top",
              align: "end",
              labels: {
                color: "#94a3b8",
                usePointStyle: true,
                pointStyle: "circle",
                padding: 20,
                font: {
                  size: 12,
                },
              },
            },
            tooltip: {
              backgroundColor: "rgba(15, 23, 42, 0.9)",
              titleColor: "#e2e8f0",
              bodyColor: "#cbd5e1",
              borderColor: "rgba(148, 163, 184, 0.2)",
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || "";
                  if (label) {
                    label += ": ";
                  }
                  if (context.parsed.y !== null) {
                    label += "$" + context.parsed.y.toFixed(2);
                  }
                  return label;
                },
              },
            },
          },
          scales: {
            x: {
              grid: {
                color: "rgba(148, 163, 184, 0.1)",
                drawBorder: false,
              },
              ticks: {
                color: "#64748b",
                font: {
                  size: 11,
                },
                maxTicksLimit: 8,
              },
            },
            y: {
              grid: {
                color: "rgba(148, 163, 184, 0.1)",
                drawBorder: false,
              },
              ticks: {
                color: "#64748b",
                font: {
                  size: 11,
                },
                callback: function (value) {
                  return "$" + value.toFixed(0);
                },
              },
            },
          },
        },
      });

      return () => {
        if (chartInstanceRef.current) {
          chartInstanceRef.current.destroy();
        }
      };
    }, [historyData]);

    return (
      <Card title="资金趋势" className="col-span-1 md:col-span-3">
        {/* 顶部状态栏和控制栏 */}
        <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
          {/* 状态信息 */}
          <div className="flex flex-wrap gap-3">
            <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-800/30 rounded-lg border border-slate-700/30">
              <span className="text-slate-400 text-xs">代理状态</span>
              <StatusBadge status={data?.status} />
            </div>
            <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-800/30 rounded-lg border border-slate-700/30">
              <span className="text-slate-400 text-xs">市场状态</span>
              <span
                className={`text-xs font-bold px-2 py-0.5 rounded border ${
                  data?.market_status === "open"
                    ? "bg-green-500/10 text-green-400 border-green-500/20"
                    : ["pre_market", "after_hours"].includes(data?.market_status)
                      ? "bg-amber-500/10 text-amber-400 border-amber-500/20"
                      : "bg-slate-500/10 text-slate-400 border-slate-500/20"
                }`}
              >
                {data?.market_status === "open"
                  ? "开盘中"
                  : data?.market_status === "pre_market"
                    ? "盘前交易"
                    : data?.market_status === "after_hours"
                      ? "盘后交易"
                      : data?.market_status === "closed"
                        ? "已休市"
                        : "未知"}
              </span>
            </div>
            <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-800/30 rounded-lg border border-slate-700/30">
              <span className="text-slate-400 text-xs">系统时间</span>
              <span className="text-xs font-mono text-slate-300">
                {formatETTimeShort(new Date())}
              </span>
            </div>
          </div>

          {/* 控制按钮 */}
          <div className="flex flex-wrap gap-2">
            {/* 时间范围选择 */}
            <div className="flex gap-2">
            <button
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                period === "1D"
                  ? "bg-cyan-500/20 text-cyan-400 border border-cyan-500/30"
                  : "bg-slate-800/50 text-slate-400 border border-slate-700/30 hover:border-slate-600/50"
              }`}
              onClick={() => setPeriod("1D")}
            >
              1天
            </button>
            <button
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                period === "1M"
                  ? "bg-cyan-500/20 text-cyan-400 border border-cyan-500/30"
                  : "bg-slate-800/50 text-slate-400 border border-slate-700/30 hover:border-slate-600/50"
              }`}
              onClick={() => setPeriod("1M")}
            >
              1月
            </button>
            <button
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                period === "3M"
                  ? "bg-cyan-500/20 text-cyan-400 border border-cyan-500/30"
                  : "bg-slate-800/50 text-slate-400 border border-slate-700/30 hover:border-slate-600/50"
              }`}
              onClick={() => setPeriod("3M")}
            >
              3月
            </button>
          </div>

          {/* 时间粒度选择 */}
          <select
            value={timeframe}
            onChange={(e) => setTimeframe(e.target.value)}
            className="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-800/50 text-slate-400 border border-slate-700/30 focus:border-cyan-500/50 outline-none"
          >
            <option value="1Min">1分钟</option>
            <option value="5Min">5分钟</option>
            <option value="15Min">15分钟</option>
            <option value="1H">1小时</option>
            <option value="1D">1天</option>
          </select>

          {/* 刷新按钮 */}
          <button
            onClick={fetchHistory}
            disabled={loading}
            className="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-800/50 text-slate-400 border border-slate-700/30 hover:border-slate-600/50 transition-all disabled:opacity-50"
          >
            {loading ? "加载中..." : "刷新"}
          </button>
          </div>
        </div>

        {/* 投资组合概览 - 在图表上方显示 */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
          <div className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/30">
            <div className="text-slate-400 text-[10px] font-medium uppercase tracking-wider mb-1">
              总权益
            </div>
            <div className="text-xl font-bold text-slate-100">
              {historyData && historyData.length > 0 ? (
                `$${historyData[historyData.length - 1]?.equity?.toFixed(2) || '-'}`
              ) : '-'}
            </div>
          </div>
          <div className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/30">
            <div className="text-slate-400 text-[10px] font-medium uppercase tracking-wider mb-1">
              日内盈亏
            </div>
            <div className="text-xl font-bold">
              {historyData && historyData.length > 1 ? (
                (() => {
                  const latest = historyData[historyData.length - 1]?.equity || 0;
                  const base = historyData[0]?.base_value || historyData[0]?.equity || 0;
                  const pl = latest - base;
                  const plClass = pl >= 0 ? 'text-emerald-400' : 'text-rose-400';
                  return <span className={plClass}>{pl >= 0 ? '+' : ''}${pl.toFixed(2)}</span>;
                })()
              ) : '-'}
            </div>
          </div>
          <div className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/30">
            <div className="text-slate-400 text-[10px] font-medium uppercase tracking-wider mb-1">
              日内收益率
            </div>
            <div className="text-xl font-bold">
              {historyData && historyData.length > 1 ? (
                (() => {
                  const latest = historyData[historyData.length - 1]?.equity || 0;
                  const base = historyData[0]?.base_value || historyData[0]?.equity || 0;
                  const plPercent = base > 0 ? ((latest - base) / base) * 100 : 0;
                  const plClass = plPercent >= 0 ? 'text-emerald-400' : 'text-rose-400';
                  return <span className={plClass}>{plPercent >= 0 ? '+' : ''}{plPercent.toFixed(2)}%</span>;
                })()
              ) : '-'}
            </div>
          </div>
          <div className="bg-slate-800/30 p-4 rounded-lg border border-slate-700/30">
            <div className="text-slate-400 text-[10px] font-medium uppercase tracking-wider mb-1">
              基准值
            </div>
            <div className="text-xl font-bold text-slate-400">
              {historyData && historyData.length > 0 ? (
                `$${historyData[0]?.base_value?.toFixed(2) || '-'}`
              ) : '-'}
            </div>
          </div>
        </div>

        {/* 图表容器 */}
        {error ? (
          <div className="text-center py-12 border border-dashed border-slate-700/50 rounded-xl bg-slate-800/20">
            <div className="text-rose-400 mb-2">获取数据失败</div>
            <div className="text-slate-500 text-xs">{error}</div>
          </div>
        ) : (
          <div className="h-80 w-full">
            <canvas ref={chartRef}></canvas>
          </div>
        )}
      </Card>
    );
  };

  const Dashboard = () => {
    const { data, status: connectionStatus } = useWebSocket(getWsUrl());

    if (!data)
      return (
        <div className="flex items-center justify-center h-64">
          <div className="flex flex-col items-center gap-4">
            <div className="w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
            <div className="text-slate-400 text-sm font-medium">
              正在连接交易引擎...
              <span className="text-xs ml-2 opacity-50">
                ({connectionStatus})
              </span>
            </div>
            {connectionStatus === "disconnected" && (
              <div className="text-rose-400 text-xs">重新连接中...</div>
            )}
          </div>
        </div>
      );

    return (
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
        {/* Portfolio History Chart - 已整合控制面板和投资组合概览 */}
        <PortfolioHistoryChart />

        {/* ML Prediction Signals */}
        <Card title="实时预测信号" className="col-span-1 md:col-span-3">
          {!data.signals || data.signals.length === 0 ? (
            <div className="text-slate-500 text-center py-8 italic border border-dashed border-slate-700/50 rounded-xl bg-slate-800/20">
              <div className="mb-2">暂无预测信号</div>
              <div className="text-xs text-slate-600">
                {data.model_loaded ? "等待下一个交易迭代..." : "ML 模型未加载"}
              </div>
            </div>
          ) : (
            <div className="overflow-x-auto rounded-lg border border-slate-700/30">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="text-slate-400 text-sm bg-slate-800/50 border-b border-slate-700/30">
                    <th className="p-4 font-medium">排名</th>
                    <th className="p-4 font-medium">代码</th>
                    <th className="p-4 font-medium">预测分数</th>
                    <th className="p-4 font-medium">预测价格</th>
                    <th className="p-4 font-medium">价格时间</th>
                    <th className="p-4 font-medium">预测时间</th>
                    <th className="p-4 font-medium">信号强度</th>
                    <th className="p-4 font-medium">状态</th>
                  </tr>
                </thead>
                <tbody className="text-slate-300 text-sm">
                  {data.signals.map((signal, i) => {
                    const score = signal.score;
                    const absScore = Math.abs(score);
                    const maxAbsScore = Math.max(
                      ...data.signals.map((s) => Math.abs(s.score)),
                      0.001,
                    );
                    const barWidth = Math.min(
                      (absScore / maxAbsScore) * 100,
                      100,
                    );
                    const isPositive = score >= 0;
                    const price =
                      signal.price !== null && signal.price !== undefined
                        ? Number(signal.price)
                        : null;

                    return (
                      <tr
                        key={i}
                        className={`border-b border-slate-800/30 hover:bg-slate-700/20 transition-colors last:border-0 ${signal.is_top_k ? "bg-cyan-900/10" : ""}`}
                      >
                        <td className="p-4">
                          <span
                            className={`inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold ${signal.is_top_k ? "bg-cyan-500/20 text-cyan-400 border border-cyan-500/30" : "bg-slate-700/30 text-slate-400"}`}
                          >
                            {signal.rank}
                          </span>
                        </td>
                        <td
                          className={`p-4 font-bold ${signal.is_top_k ? "text-cyan-300" : "text-slate-300"}`}
                        >
                          {signal.symbol}
                          {signal.is_top_k && (
                            <span className="ml-2 text-[10px] bg-cyan-500/20 text-cyan-400 px-1.5 py-0.5 rounded font-normal border border-cyan-500/30">
                              TOP-K
                            </span>
                          )}
                        </td>
                        <td
                          className={`p-4 font-mono ${isPositive ? "text-emerald-400" : "text-rose-400"}`}
                        >
                          <AnimatedNumber
                            value={score}
                            decimals={6}
                            showSign
                          />
                        </td>
                        <td className="p-4 font-mono text-slate-300">
                          <AnimatedNumber
                            value={price}
                            decimals={2}
                          />
                        </td>
                        <td className="p-4 font-mono text-slate-400">
                          {signal.price_time ? formatETTime(signal.price_time) : "-"}
                        </td>
                        <td className="p-4 font-mono text-slate-400">
                          {signal.time ? formatETTime(signal.time) : "-"}
                        </td>
                        <td className="p-4">
                          <div className="w-full bg-slate-700/30 rounded-full h-2 overflow-hidden">
                            <div
                              className={`h-full rounded-full transition-all duration-300 ${isPositive ? "bg-gradient-to-r from-emerald-500/50 to-emerald-400" : "bg-gradient-to-r from-rose-500/50 to-rose-400"}`}
                              style={{ width: `${barWidth}%` }}
                            />
                          </div>
                        </td>
                        <td className="p-4">
                          <span
                            className={`px-2 py-0.5 rounded text-xs font-medium uppercase ${isPositive ? "bg-emerald-500/10 text-emerald-400 border border-emerald-500/20" : "bg-rose-500/10 text-rose-400 border border-rose-500/20"}`}
                          >
                            {isPositive ? "看多" : "看空"}
                          </span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </Card>
        {console.log(data)}
        {/* Positions */}
        <Card title="当前持仓" className="col-span-1 md:col-span-3">
          {data.portfolio.positions.length === 0 ? (
            <div className="text-slate-500 text-center py-12 italic border border-dashed border-slate-700/50 rounded-xl bg-slate-800/20">
              暂无活跃持仓
            </div>
          ) : (
            <div className="overflow-x-auto rounded-lg border border-slate-700/30">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="text-slate-400 text-sm bg-slate-800/50 border-b border-slate-700/30">
                    <th className="p-4 font-medium">代码</th>
                    <th className="p-4 font-medium">数量</th>
                    <th className="p-4 font-medium">平均成本</th>
                    <th className="p-4 font-medium">现价</th>
                    <th className="p-4 font-medium">盈亏 (P/L)</th>
                  </tr>
                </thead>
                <tbody className="text-slate-300 text-sm">
                  {data.portfolio.positions.map((pos, i) => {
                    const pl = pos.unrealized_pl || 0.0;
                    // Use backend provided percentage if available, otherwise calculate fallback
                    const plPercent =
                      pos.unrealized_plpc !== undefined
                        ? pos.unrealized_plpc * 100
                        : pos.average_price !== 0
                          ? (pl /
                              (pos.average_price * Math.abs(pos.quantity))) *
                            100
                          : 0;

                    return (
                      <tr
                        key={i}
                        className="border-b border-slate-800/30 hover:bg-slate-700/20 transition-colors last:border-0"
                      >
                        <td className="p-4 font-bold text-cyan-300">
                          {pos.symbol}
                          {pos.asset_class &&
                            !["stock", "us_equity"].includes(
                              pos.asset_class.toLowerCase(),
                            ) && (
                              <span className="ml-2 text-[10px] bg-slate-700 text-slate-400 px-1 py-0.5 rounded uppercase font-normal">
                                {pos.asset_class}
                              </span>
                            )}
                        </td>
                        <td className="p-4">{pos.quantity}</td>
                        <td className="p-4 text-slate-400">
                          <AnimatedNumber
                            value={pos.average_price}
                            decimals={2}
                            prefix="$"
                          />
                        </td>
                        <td className="p-4">
                          <AnimatedNumber
                            value={pos.current_price}
                            decimals={2}
                            prefix="$"
                          />
                        </td>
                        <td
                          className={`p-4 font-bold ${pl >= 0 ? "text-emerald-400" : "text-rose-400"}`}
                        >
                          <AnimatedNumber
                            value={pl}
                            decimals={2}
                            showSign
                          />{" "}
                          <span className="text-xs opacity-70 ml-1">
                            (
                            <AnimatedNumber
                              value={plPercent}
                              decimals={2}
                              showSign
                              suffix="%"
                            />
                            )
                          </span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </Card>

        {/* Orders */}
        <Card title="最近订单" className="col-span-1 md:col-span-3">
          {!data.orders || data.orders.length === 0 ? (
            <div className="text-slate-500 text-center py-8 italic border border-dashed border-slate-700/50 rounded-xl bg-slate-800/20">
              暂无订单记录
            </div>
          ) : (
            <div className="overflow-x-auto rounded-lg border border-slate-700/30">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="text-slate-400 text-sm bg-slate-800/50 border-b border-slate-700/30">
                    <th className="p-4 font-medium">时间</th>
                    <th className="p-4 font-medium">代码</th>
                    <th className="p-4 font-medium">操作</th>
                    <th className="p-4 font-medium">意图</th>
                    <th className="p-4 font-medium">数量</th>
                    <th className="p-4 font-medium">价格</th>
                    <th className="p-4 font-medium">状态</th>
                  </tr>
                </thead>
                <tbody className="text-slate-300 text-sm">
                  {data.orders.map((order, i) => (
                    <tr
                      key={i}
                      className="border-b border-slate-800/30 hover:bg-slate-700/20 transition-colors last:border-0"
                    >
                      <td className="p-4 text-slate-400 text-xs font-mono">
                        {formatETTimeShort(order.timestamp)}
                      </td>
                      <td className="p-4 font-bold text-cyan-300">
                        {order.symbol}
                      </td>
                      <td className="p-4">
                        <span
                          className={`px-2 py-0.5 rounded text-xs font-bold uppercase ${order.action === "BUY" ? "bg-emerald-500/20 text-emerald-400" : "bg-rose-500/20 text-rose-400"}`}
                        >
                          {order.action}
                        </span>
                      </td>
                      <td className="p-4 text-xs font-mono text-slate-400 uppercase">
                        {order.intent || "-"}
                      </td>
                      <td className="p-4">{order.quantity}</td>
                      <td className="p-4 text-slate-400">
                        <AnimatedNumber
                          value={order.price}
                          decimals={2}
                          prefix="$"
                        />
                      </td>
                      <td className="p-4 text-xs uppercase tracking-wider text-slate-500">
                        {order.status}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </Card>

        {/* Logs */}
        <Card
          title="系统日志"
          className="col-span-1 md:col-span-3 h-96 flex flex-col"
        >
          <div className="flex-1 overflow-y-auto font-mono text-xs space-y-1 p-4 bg-slate-950/40 rounded-xl border border-slate-800/50 shadow-inner">
            {data.logs.length === 0 && (
              <div className="text-slate-600 italic text-center mt-10">
                暂无日志...
              </div>
            )}
            {data.logs
              .slice()
              .reverse()
              .map((log, i) => (
                <div
                  key={i}
                  className="text-slate-400 border-b border-slate-800/30 pb-1.5 mb-1.5 last:border-0 last:mb-0 break-words flex gap-2"
                >
                  <span className="text-cyan-500/70 shrink-0">➜</span>
                  <span>{log}</span>
                </div>
              ))}
          </div>
        </Card>
      </div>
    );
  };

  const root = ReactDOM.createRoot(document.getElementById("dashboard-root"));
  root.render(<Dashboard />);
</script>
{% endraw %} {% endblock %}
