{% extends "layout.html" %} {% block content %}
<div id="cache-root"></div>
{% endblock %} {% block scripts %}
<script type="text/babel">
  {% raw %}
  const CachePage = () => {
    const [cacheInfo, setCacheInfo] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    const [error, setError] = React.useState(null);
    const [selectedInterval, setSelectedInterval] = React.useState("5min");

    // æ•°æ®åŒæ­¥ç›¸å…³çŠ¶æ€
    const [syncInProgress, setSyncInProgress] = React.useState(false);

    // åŠ è½½ç¼“å­˜ä¿¡æ¯
    const loadCacheInfo = async () => {
      try {
        setLoading(true);
        setError(null);
        const res = await fetch("/api/data/cache");
        const data = await res.json();

        if (data.status === "success") {
          setCacheInfo(data.cache_info);
          // å¦‚æœå½“å‰é€‰æ‹©çš„é¢‘ç‡æ²¡æœ‰æ•°æ®ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„é¢‘ç‡
          if (data.cache_info && Object.keys(data.cache_info).length > 0) {
            if (!data.cache_info[selectedInterval]) {
              setSelectedInterval(Object.keys(data.cache_info)[0]);
            }
          }
        } else {
          setError(data.error || "åŠ è½½å¤±è´¥");
        }
      } catch (e) {
        console.error("åŠ è½½ç¼“å­˜ä¿¡æ¯å¤±è´¥:", e);
        setError("åŠ è½½ç¼“å­˜ä¿¡æ¯å¤±è´¥: " + e.message);
      } finally {
        setLoading(false);
      }
    };

    // æ£€æŸ¥åŒæ­¥çŠ¶æ€
    const checkSyncStatus = async () => {
      try {
        const res = await fetch("/api/data/sync/status");
        const status = await res.json();
        setSyncInProgress(status?.in_progress || false);
      } catch (e) {
        console.error("æ£€æŸ¥åŒæ­¥çŠ¶æ€å¤±è´¥:", e);
      }
    };

    React.useEffect(() => {
      loadCacheInfo();
      checkSyncStatus();
      const interval = setInterval(() => {
        loadCacheInfo();
        checkSyncStatus();
      }, 10000); // æ¯10ç§’åˆ·æ–°
      return () => clearInterval(interval);
    }, []);

    // å¯åŠ¨æ•°æ®åŒæ­¥
    const handleDataSync = async () => {
      try {
        await fetch("/api/data/sync", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({}),
        });
        checkSyncStatus();
      } catch (e) {
        console.error("å¯åŠ¨æ•°æ®åŒæ­¥å¤±è´¥:", e);
      }
    };

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    const formatFileSize = (sizeMb) => {
      if (sizeMb < 1) {
        return `${(sizeMb * 1024).toFixed(2)} KB`;
      }
      return `${sizeMb.toFixed(2)} MB`;
    };

    // è®¡ç®—æ—¶é—´è·¨åº¦
    const calculateTimeSpan = (startDate, endDate) => {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));

      if (diffDays > 365) {
        return `${(diffDays / 365).toFixed(1)} å¹´`;
      } else if (diffDays > 30) {
        return `${(diffDays / 30).toFixed(1)} ä¸ªæœˆ`;
      } else if (diffDays > 0) {
        return `${diffDays} å¤©`;
      } else {
        return `${diffHours} å°æ—¶`;
      }
    };

    // é¢‘ç‡æ ‡ç­¾æ˜ å°„
    const intervalLabels = {
      "1min": "1 åˆ†é’Ÿ",
      "5min": "5 åˆ†é’Ÿ",
      "15min": "15 åˆ†é’Ÿ",
      "30min": "30 åˆ†é’Ÿ",
      "1h": "1 å°æ—¶",
      "4h": "4 å°æ—¶",
      "1d": "1 å¤©",
    };

    if (loading) {
      return (
        <div className="flex items-center justify-center h-64">
          <div className="flex flex-col items-center gap-4">
            <div className="w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
            <div className="text-slate-400 text-sm font-medium">åŠ è½½ä¸­...</div>
          </div>
        </div>
      );
    }

    if (error) {
      return (
        <div className="space-y-6">
          <header className="mb-8 flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-bold text-slate-100 flex items-center gap-3">
                ğŸ’¾ ç¼“å­˜ç®¡ç†
              </h2>
              <p className="text-slate-400 mt-2">
                æŸ¥çœ‹æœ¬åœ° Parquet æ•°æ®ç¼“å­˜ï¼Œè¿è¡Œå›æµ‹åæ•°æ®ä¼šè‡ªåŠ¨ç¼“å­˜ã€‚
              </p>
            </div>
          </header>

          <div className="p-6 bg-red-500/10 border border-red-500/30 rounded-xl">
            <div className="flex items-center gap-3">
              <span className="text-2xl">âš ï¸</span>
              <div>
                <div className="text-red-400 font-bold">åŠ è½½å¤±è´¥</div>
                <div className="text-red-300/70 text-sm mt-1">{error}</div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // æ²¡æœ‰ç¼“å­˜æ•°æ®
    if (!cacheInfo || Object.keys(cacheInfo).length === 0) {
      return (
        <div className="space-y-6">
          <header className="mb-8 flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-bold text-slate-100 flex items-center gap-3">
                ğŸ’¾ ç¼“å­˜ç®¡ç†
              </h2>
              <p className="text-slate-400 mt-2">
                æŸ¥çœ‹æœ¬åœ° Parquet æ•°æ®ç¼“å­˜ï¼Œè¿è¡Œå›æµ‹åæ•°æ®ä¼šè‡ªåŠ¨ç¼“å­˜ã€‚
              </p>
            </div>

            <button
              onClick={handleDataSync}
              disabled={syncInProgress}
              className={`px-6 py-3 rounded-xl font-bold text-sm transition-all flex items-center gap-2 ${
                syncInProgress
                  ? "bg-slate-800 text-slate-500 cursor-not-allowed"
                  : "bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 hover:scale-[1.01]"
              }`}
            >
              {syncInProgress ? (
                <>
                  <div className="w-4 h-4 border-2 border-slate-500 border-t-transparent rounded-full animate-spin"></div>
                  æ­£åœ¨åŒæ­¥...
                </>
              ) : (
                <>ğŸ“¥ åŒæ­¥æ•°æ®</>
              )}
            </button>
          </header>

          <div className="p-12 bg-slate-800/20 border border-dashed border-slate-700/50 rounded-2xl text-center">
            <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-4">
              <span className="text-2xl">ğŸ“­</span>
            </div>
            <h3 className="text-lg font-bold text-slate-300">æš‚æ— ç¼“å­˜æ•°æ®</h3>
            <p className="text-sm text-slate-500 max-w-sm mt-2">
              å½“å‰æ²¡æœ‰ä»»ä½• Parquet ç¼“å­˜æ–‡ä»¶ã€‚è¿è¡Œå›æµ‹åï¼Œæ•°æ®ä¼šè‡ªåŠ¨ç¼“å­˜åˆ°æœ¬åœ°ï¼Œæˆ–è€…ä½¿ç”¨å³ä¸Šè§’"åŒæ­¥æ•°æ®"åŠŸèƒ½ã€‚
            </p>
          </div>
        </div>
      );
    }

    // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    const currentData = cacheInfo[selectedInterval] || [];
    const totalRecords = currentData.reduce((sum, item) => sum + item.record_count, 0);
    const totalSize = currentData.reduce((sum, item) => sum + item.file_size_mb, 0);

    return (
      <div className="space-y-6">
        <header className="mb-8 flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold text-slate-100 flex items-center gap-3">
              ğŸ’¾ ç¼“å­˜ç®¡ç†
            </h2>
            <p className="text-slate-400 mt-2">
              æŸ¥çœ‹æœ¬åœ° Parquet æ•°æ®ç¼“å­˜ï¼Œè¿è¡Œå›æµ‹åæ•°æ®ä¼šè‡ªåŠ¨ç¼“å­˜ã€‚
            </p>
          </div>

          <button
            onClick={handleDataSync}
            disabled={syncInProgress}
            className={`px-6 py-3 rounded-xl font-bold text-sm transition-all flex items-center gap-2 ${
              syncInProgress
                ? "bg-slate-800 text-slate-500 cursor-not-allowed"
                : "bg-gradient-to-r from-cyan-600 to-blue-600 text-white shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/40 hover:scale-[1.01]"
            }`}
          >
            {syncInProgress ? (
              <>
                <div className="w-4 h-4 border-2 border-slate-500 border-t-transparent rounded-full animate-spin"></div>
                æ­£åœ¨åŒæ­¥...
              </>
            ) : (
              <>ğŸ“¥ åŒæ­¥æ•°æ®</>
            )}
          </button>
        </header>

        {/* é¢‘ç‡é€‰æ‹©å™¨ */}
        <div className="flex flex-wrap gap-2">
          {Object.keys(cacheInfo).map((interval) => (
            <button
              key={interval}
              onClick={() => setSelectedInterval(interval)}
              className={`px-4 py-2 rounded-lg font-medium text-sm transition-all ${
                selectedInterval === interval
                  ? "bg-cyan-500 text-white shadow-lg shadow-cyan-500/20"
                  : "bg-slate-800 text-slate-400 hover:bg-slate-700"
              }`}
            >
              {intervalLabels[interval] || interval}
            </button>
          ))}
        </div>

        {/* ç»Ÿè®¡æ‘˜è¦ */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className="p-4 bg-gradient-to-br from-cyan-500/10 to-blue-500/10 rounded-xl border border-cyan-500/20">
            <div className="text-[10px] text-cyan-400 font-bold uppercase mb-1">æ•°æ®é¢‘ç‡</div>
            <div className="text-xl font-black text-cyan-300">
              {intervalLabels[selectedInterval] || selectedInterval}
            </div>
          </div>

          <div className="p-4 bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl border border-purple-500/20">
            <div className="text-[10px] text-purple-400 font-bold uppercase mb-1">è‚¡ç¥¨æ•°é‡</div>
            <div className="text-xl font-black text-purple-300">{currentData.length}</div>
          </div>

          <div className="p-4 bg-gradient-to-br from-amber-500/10 to-orange-500/10 rounded-xl border border-amber-500/20">
            <div className="text-[10px] text-amber-400 font-bold uppercase mb-1">æ€»æ•°æ®ç‚¹</div>
            <div className="text-xl font-black text-amber-300">
              {totalRecords.toLocaleString()}
            </div>
          </div>

          <div className="p-4 bg-gradient-to-br from-emerald-500/10 to-teal-500/10 rounded-xl border border-emerald-500/20">
            <div className="text-[10px] text-emerald-400 font-bold uppercase mb-1">æ€»å¤§å°</div>
            <div className="text-xl font-black text-emerald-300">
              {formatFileSize(totalSize)}
            </div>
          </div>
        </div>

        {/* æ•°æ®è¡¨æ ¼ */}
        <Card title={`${intervalLabels[selectedInterval] || selectedInterval} ç¼“å­˜è¯¦æƒ…`} className="overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-slate-700/50">
                  <th className="text-left py-3 px-4 text-slate-400 font-bold text-xs uppercase tracking-wider">
                    è‚¡ç¥¨ä»£ç 
                  </th>
                  <th className="text-left py-3 px-4 text-slate-400 font-bold text-xs uppercase tracking-wider">
                    å¼€å§‹æ—¶é—´
                  </th>
                  <th className="text-left py-3 px-4 text-slate-400 font-bold text-xs uppercase tracking-wider">
                    ç»“æŸæ—¶é—´
                  </th>
                  <th className="text-left py-3 px-4 text-slate-400 font-bold text-xs uppercase tracking-wider">
                    æ—¶é—´è·¨åº¦
                  </th>
                  <th className="text-right py-3 px-4 text-slate-400 font-bold text-xs uppercase tracking-wider">
                    æ•°æ®ç‚¹æ•°é‡
                  </th>
                  <th className="text-right py-3 px-4 text-slate-400 font-bold text-xs uppercase tracking-wider">
                    æ–‡ä»¶å¤§å°
                  </th>
                </tr>
              </thead>
              <tbody>
                {currentData.map((item, idx) => (
                  <tr
                    key={item.symbol}
                    className={`border-b border-slate-700/30 hover:bg-slate-700/20 transition-colors ${
                      idx % 2 === 0 ? "bg-slate-800/20" : ""
                    }`}
                  >
                    <td className="py-3 px-4">
                      <span className="inline-flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full bg-cyan-500"></span>
                        <span className="font-mono font-bold text-cyan-300">{item.symbol}</span>
                      </span>
                    </td>
                    <td className="py-3 px-4 text-slate-300 font-mono text-xs">
                      {item.start_date}
                    </td>
                    <td className="py-3 px-4 text-slate-300 font-mono text-xs">
                      {item.end_date}
                    </td>
                    <td className="py-3 px-4">
                      <span className="inline-flex items-center px-2 py-1 rounded bg-slate-700/50 text-slate-300 text-xs">
                        ğŸ“… {calculateTimeSpan(item.start_date, item.end_date)}
                      </span>
                    </td>
                    <td className="py-3 px-4 text-right">
                      <span className="font-mono text-amber-300">
                        {item.record_count.toLocaleString()}
                      </span>
                    </td>
                    <td className="py-3 px-4 text-right">
                      <span className="font-mono text-emerald-300">
                        {formatFileSize(item.file_size_mb)}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>

        {/* æ“ä½œæç¤º */}
        <div className="p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
          <div className="flex items-start gap-3">
            <span className="text-xl">ğŸ’¡</span>
            <div className="flex-1">
              <div className="text-sm font-bold text-blue-300">ç¼“å­˜è¯´æ˜</div>
              <div className="text-xs text-blue-200/70 mt-1 space-y-1">
                <div>â€¢ ç¼“å­˜æ–‡ä»¶ä¿å­˜åœ¨ <code className="px-1.5 py-0.5 bg-slate-800 rounded text-blue-300 font-mono">datasets/{selectedInterval}/</code> ç›®å½•</div>
                <div>â€¢ è¿è¡Œå›æµ‹æ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œå¤§å¹…æå‡é€Ÿåº¦</div>
                <div>â€¢ æ¯ä¸ªè‚¡ç¥¨çš„ç¼“å­˜æ–‡ä»¶æ ¼å¼: <code className="px-1.5 py-0.5 bg-slate-800 rounded text-blue-300 font-mono">SYMBOL_INTERVAL.parquet</code></div>
                <div>â€¢ æ”¯æŒæ—¶é—´èŒƒå›´è¿‡æ»¤ï¼šå³ä½¿ç¼“å­˜åŒ…å«æ›´é•¿æ—¶é—´èŒƒå›´ï¼Œä¹Ÿèƒ½æå–æ‰€éœ€æ—¶é—´æ®µ</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const root = ReactDOM.createRoot(document.getElementById("cache-root"));
  root.render(<CachePage />);
  {% endraw %}
</script>
{% endblock %}
